@page "/gestao/utilizadores"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using MyMedia.Data.Models
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthProvider
@attribute [Authorize(Roles = "Administrador, Funcionário")]

<h3 class="mb-4">Gestão de Utilizadores</h3>

@if (utilizadoresWrapper == null)
{
    <div class="spinner-border text-primary" role="status"></div>
}
else
{
    <table class="table table-striped align-middle shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Estado</th>
                <th>Cargos</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in utilizadoresWrapper)
            {
                <tr>
                    <td>@u.User.NomeCompleto</td>
                    <td>@u.User.Email</td>
                    <td>
                        <span class="badge @(u.User.IsAtivo ? "bg-success" : "bg-warning text-dark")">
                            @(u.User.IsAtivo ? "Ativo" : "Pendente")
                        </span>
                    </td>
                    <td>
                        @foreach (var role in u.Roles)
                        {
                            <span class="badge bg-info text-dark me-1">@role</span>
                        }
                    </td>
                    <td>
                        @if (u.User.Id != currentUserId)
                        {
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm" @onclick="() => AbrirModalPerfil(u)">
                                    <i class="bi bi-person-gear"></i> Perfil
                                </button>
                                <button class="btn btn-sm @(u.User.IsAtivo ? "btn-outline-danger" : "btn-outline-success")"
                                        @onclick="() => AlternarEstado(u.User)">
                                    @(u.User.IsAtivo ? "Inativar" : "Ativar")
                                </button>
                            </div>
                        }
                        else
                        {
                            <span class="text-muted small"><i class="bi bi-lock-fill"></i> Própria Conta</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (mostrarModalPerfil)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gerir Perfil: @userSelecionado?.User.NomeCompleto</h5>
                    <button type="button" class="btn-close" @onclick="() => mostrarModalPerfil = false"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Selecione o cargo para este utilizador:</p>
                    <div class="list-group">

                        @if (currentUserIsAdmin)
                        {
                            <button class="list-group-item list-group-item-action @(userSelecionado!.Roles.Contains("Funcionário") ? "active" : "")"
                                    @onclick='() => MudarCargo("Funcionário")'>
                                <i class="bi bi-briefcase-fill me-2"></i> Funcionário
                            </button>
                        }

                        <button class="list-group-item list-group-item-action @(userSelecionado!.Roles.Contains("Fornecedor") ? "active" : "")"
                                @onclick='() => MudarCargo("Fornecedor")'>
                            <i class="bi bi-truck me-2"></i> Fornecedor
                        </button>

                        <button class="list-group-item list-group-item-action @(userSelecionado.Roles.Contains("Cliente") ? "active" : "")"
                                @onclick='() => MudarCargo("Cliente")'>
                            <i class="bi bi-person me-2"></i> Cliente (Padrão)
                        </button>
                    </div>

                    @if (!currentUserIsAdmin)
                    {
                        <div class="alert alert-secondary mt-3 small py-2">
                            <i class="bi bi-info-circle me-1"></i> Apenas Administradores podem gerir o cargo de Funcionário.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => mostrarModalPerfil = false">Fechar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserRoleWrapper>? utilizadoresWrapper;
    private string? currentUserId;
    private bool currentUserIsAdmin = false; 
    private bool mostrarModalPerfil = false;
    private UserRoleWrapper? userSelecionado;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        currentUserId = UserManager.GetUserId(user);

        currentUserIsAdmin = user.IsInRole("Administrador");

        await CarregarUtilizadores();
    }

    private async Task CarregarUtilizadores()
    {
        var users = await UserManager.Users.ToListAsync();
        var listaTemp = new List<UserRoleWrapper>();

        foreach (var u in users)
        {
            var roles = await UserManager.GetRolesAsync(u);
            listaTemp.Add(new UserRoleWrapper { User = u, Roles = roles.ToList() });
        }
        utilizadoresWrapper = listaTemp;
    }

    private async Task AlternarEstado(ApplicationUser user)
    {
        user.IsAtivo = !user.IsAtivo;
        user.EmailConfirmed = user.IsAtivo;
        await UserManager.UpdateAsync(user);
        await CarregarUtilizadores();
    }

    private void AbrirModalPerfil(UserRoleWrapper wrapper)
    {
        userSelecionado = wrapper;
        mostrarModalPerfil = true;
    }

    private async Task MudarCargo(string novoCargo)
    {
        if (userSelecionado == null) return;

        if (novoCargo == "Funcionário" && !currentUserIsAdmin) return;

        var rolesAtuais = await UserManager.GetRolesAsync(userSelecionado.User);

        var rolesToRemove = rolesAtuais.Where(r => r != "Administrador");
        await UserManager.RemoveFromRolesAsync(userSelecionado.User, rolesToRemove);

        await UserManager.AddToRoleAsync(userSelecionado.User, novoCargo);

        mostrarModalPerfil = false;
        await CarregarUtilizadores();
    }

    public class UserRoleWrapper
    {
        public ApplicationUser User { get; set; } = default!;
        public List<string> Roles { get; set; } = new();
    }
}